<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dual Deck Vinyl Tempo Helper — v17 (click ±0,1 • 1 decimal)</title>
<style>
  :root{
    --bg:#0d0f10;
    --panel:#121416;
    --ink:#e9edf1;
    --muted:#9aa3ad;
    --muted2:#6b7380;
    --accent:#73a7ff;
    --accent-2:#2563eb;
    --chip:#a7c4ff;
    --tick:#2a2f36;
    --tick-strong:#3a414b;
    --tick-0:#2f66ff;
    --btn:#171a1e;
    --btn2:#191d22;
    --shadow:0 6px 24px rgba(0,0,0,.35);
    --green:#00ff9d; /* LED Technics */
    --green-bg: rgba(0,255,157,.16);
    --green-border: rgba(0,255,157,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
  }
  h1{ text-align:center;font-weight:800;letter-spacing:.04em;margin:22px 10px 18px;
      font-size:clamp(22px,3.2vw,44px) }
  .toolbar{ display:none;  display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:0 12px 16px }
  .pill{ background:var(--btn2);border:1px solid #222831;color:var(--ink);
         padding:10px 14px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow) }
  .pill[aria-pressed="true"]{outline:2px solid var(--accent-2)}
  .wrap{ display:grid;gap:18px;grid-template-columns:1fr;max-width:1200px;margin:0 auto 70px;padding:0 14px 24px }
  @media(min-width:980px){ .wrap{grid-template-columns:1fr 1fr} }
  .deck{ background:var(--panel);border-radius:18px;padding:18px 18px 20px;box-shadow:var(--shadow);position:relative }
  .deck h2{letter-spacing:.12em;font-weight:800;margin:2px 0 12px}
  .stat{ font-size:14px;color:var(--muted) }
  .stat b{color:var(--ink)}
  .bpm-edit{ display:flex;align-items:center;gap:10px;margin:10px 0 18px }
  .btn{ background:var(--btn);border:1px solid #232831;color:var(--ink);
        border-radius:10px;padding:8px 12px;cursor:pointer;user-select:none }
  .bpm-field{
    width:min(16ch, 100%);background:#0f1114;border:1px solid #272d36;border-radius:12px;
    color:var(--ink);padding:10px 12px;text-align:center;font-weight:800;
    font-size: clamp(16px, 3vw, 26px);
    line-height:1;
  }
  .rail-wrap{ display:flex;justify-content:center;align-items:center;min-height:380px;margin:6px 0 18px;gap:20px }
  .rail{ position:relative; overflow:visible;width:70px;height:320px;border-radius:20px;background:#14181d;
         border:1px solid #242b34;box-shadow:inset 0 0 0 1px #101317, 0 10px 22px rgba(0,0,0,.25) }
  .rail .edge{ position:absolute;left:6px;right:6px;top:8px;bottom:8px;border-radius:16px;background:#0e1013 }
  .ticks{position:absolute;inset:10px 0 10px 0;pointer-events:none}
  .tick{ position:absolute;left:0;right:0;height:1px;background:var(--tick);opacity:.9 }
  .tick.long{background:var(--tick-strong);left:10px;right:10px}
  .tick .label{ position:absolute; left:-32px; top:-9px; width:24px; text-align:right; transform:none; font-size:12px; color:#8e98a6 }
  .tick.zero{height:2px;background:var(--tick-0)}
  .rail .endmark{ position:absolute;left:8px;right:8px;color:#7b8594;font-weight:800;text-align:center }
  .rail .endmark.top{top:-2px}.rail .endmark.bot{bottom:-2px}
  .thumb{ position:absolute;left:50%;transform:translate(-50%,-50%);
          width:72px;height:40px;border-radius:14px;
          background:transparent; border:1px solid rgba(103,149,255,.45);
          display:flex;align-items:center;justify-content:center;color:#dff;font-weight:800 }
  .thumb:focus{outline:3px solid #2563eb}
  .ghost{ position:absolute;left:12px;right:12px;height:0;border-top:2px dashed #8c95a33a;border-radius:4px }
  .chip{ display:inline-flex;gap:8px;align-items:center;background:rgba(116,155,255,.18);
         color:#d7e5ff;border:1px solid rgba(116,155,255,.5);padding:6px 10px;border-radius:999px;font-size:12px;margin-left:6px }
  .chip.green{ background:var(--green-bg); border-color:var(--green-border); color:var(--green) }
  .controls{ display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr }
  .controls .btn{width:100%;padding:12px 14px;border-radius:12px}
  .footer-chip{ position:fixed;right:18px;bottom:18px;background:rgba(82,126,255,.18);
                color:#dfe8ff;border:1px solid rgba(82,126,255,.45);border-radius:999px;padding:10px 14px;box-shadow:var(--shadow) }

  /* === Readouts twin boxes (Original BPM & Current Tempo) === */
  .readouts{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:stretch; margin:12px 0 10px }
  .tempo-box, .orig-box{
    border-radius:16px; padding:14px 16px; display:flex; flex-direction:column; gap:10px;
    box-shadow:0 4px 18px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.05);
    min-height:70px;
  }
  .orig-box{
    background:linear-gradient(180deg, rgba(20,26,42,.66), rgba(18,24,40,.86));
    border:1.5px solid #2a3b61;
  }
  .tempo-box{
    background:linear-gradient(180deg, rgba(29,41,68,.75), rgba(21,32,58,.92));
    border:1.8px solid #4b6bd8;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
  }
  .tempo-title, .orig-title{
    font-weight:700; letter-spacing:.01em; color:#dfe7fb; font-size:1rem;
    display:flex; align-items:center; gap:10px;
  }
  .tempo-value{
    font-weight:900; line-height:1; font-variant-numeric: tabular-nums;
    font-size: clamp(16px, 3vw, 26px);
    text-align:center;
    display:flex;
    align-items:center;
    justify-content:center;
    height:100%;
    line-height:1;
  }
  .controls { display: grid; gap: 10px; grid-template-columns: 1fr 1fr 1fr; }
  .controls .btn[data-align] {
    background: linear-gradient(180deg, #1d2c4a, #16223a);
    border: 1.5px solid #3b6cff;
    color: #dce6ff;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .controls .btn[data-align]:hover {
    background: linear-gradient(180deg, #2b4fa3, #1a2d55);
    border-color: #5e85ff;
  }

  .thumb::after{
    content:'';
    position:absolute;
    left:10%; right:10%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 6px rgba(118,160,255,.25);
    border-radius:1px;
    pointer-events:none;
  }

  .thumb-readout{
    position:absolute; right:-84px; top:50%; transform:translateY(-50%);
    min-width:70px; padding:6px 10px; border-radius:12px;
    background:rgba(29,41,68,.92); border:1.2px solid #4b6bb8;
    color:#e7f0ff; font-weight:800; text-align:center; pointer-events:none;
    box-shadow:0 4px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
    z-index:6;
  }
</style>

<!-- Compact laptop overrides -->
<style id="compact-laptop-overrides">
  :root{ --compact-factor: 0.88; }
  body{ font-size: 14px; line-height: 1.4; }
  h1{ margin:16px 8px 12px; font-size: clamp(20px, 2.4vw, 34px); }
  .toolbar{ display:none;  gap:8px; margin:0 10px 12px }
  .pill{ padding:8px 12px; border-radius: 999px }
  .wrap{ gap:14px; max-width:1100px; margin:0 auto 40px; padding:0 10px 16px; }
  .deck{ border-radius:14px; padding:14px 14px 16px; }
  .deck h2{ margin:2px 0 10px }
  .stat{ font-size:12px }
  .bpm-edit{ gap:8px; margin:8px 0 14px }
  .btn{ padding:6px 10px; border-radius:10px }
  .bpm-field{ padding:8px 10px; font-size: clamp(14px, 2.2vw, 22px); }
  .readouts{ gap:12px; margin:10px 0 8px }
  .tempo-box, .orig-box{ border-radius:14px; padding:12px 14px; min-height:60px }
  .tempo-title, .orig-title{ font-size: .9rem }
  .tempo-value{ font-size: clamp(14px, 2.4vw, 22px); }
  .rail-wrap{ min-height: 320px; margin:6px 0 14px; gap:14px }
  .rail{ width:56px; height:260px; border-radius:16px; }
  .rail .edge{ left:5px; right:5px; top:6px; bottom:6px; border-radius:12px }
  .tick .label{ font-size:10px; top:-8px }
  .thumb{ width:60px; height:34px; border-radius:12px; font-weight:800; font-size:12px; }
  .ghost{ left:10px; right:10px }
  .controls{ gap:8px; grid-template-columns: 1fr 1fr 1fr }
  .controls .btn{ padding:10px 12px; border-radius:10px; font-size:.95rem }
  .footer-chip{ right:14px; bottom:14px; padding:8px 12px; font-size:12px }

  .thumb::after{
    content:'';
    position:absolute;
    left:10%; right:10%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 6px rgba(118,160,255,.25);
    border-radius:1px;
    pointer-events:none;
  }

  .thumb-readout{
    position:absolute; right:-84px; top:50%; transform:translateY(-50%);
    min-width:70px; padding:6px 10px; border-radius:12px;
    background:rgba(29,41,68,.92); border:1.2px solid #4b6bb8;
    color:#e7f0ff; font-weight:800; text-align:center; pointer-events:none;
    box-shadow:0 4px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
    z-index:6;
  }
</style>

<!-- Fader XL overrides (~40% bigger) -->
<style id="fader-xl-overrides">
  .rail-wrap{ min-height: 450px; margin: 8px 0 16px; gap: 16px; }
  .rail{ width: 78px; height: 364px; border-radius: 18px; }
  .rail .edge{ left: 6px; right: 6px; top: 7px; bottom: 7px; border-radius: 14px; }
  .tick .label{ font-size: 12px; top: -9px; }
  .thumb{ width: 84px; height: 44px; border-radius: 14px; font-size: 14px; }
  .rail .endmark{ font-size: 13px; }

  .thumb::after{
    content:'';
    position:absolute;
    left:10%; right:10%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 6px rgba(118,160,255,.25);
    border-radius:1px;
    pointer-events:none;
  }

  .thumb-readout{
    position:absolute; right:-84px; top:50%; transform:translateY(-50%);
    min-width:70px; padding:6px 10px; border-radius:12px;
    background:rgba(29,41,68,.92); border:1.2px solid #4b6bb8;
    color:#e7f0ff; font-weight:800; text-align:center; pointer-events:none;
    box-shadow:0 4px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
    z-index:6;
  }
</style>

<!-- Fit-on-laptop vertical compactor -->
<style id="fit-on-laptop">
  h1{ margin: 8px 8px 6px; font-size: clamp(18px, 2.1vw, 28px); }
  .toolbar{ display:none; margin: 0 8px 6px; gap: 6px; }
  .pill{ padding:6px 10px }
  .wrap{ margin: 0 auto 16px; padding: 0 8px 12px; gap: 12px; }
  .deck{ padding: 10px 10px 12px; border-radius: 12px; }
  .deck h2{ margin: 2px 0 6px }
  .readouts{ margin: 6px 0 4px; gap: 10px; }
  .tempo-box, .orig-box{ padding: 10px 12px; min-height: 52px; border-radius: 12px; }
  .tempo-title, .orig-title{ font-size: .85rem }
  .bpm-edit{ margin:6px 0 10px; gap:6px }
  .bpm-field{ padding:7px 10px }
  .stat{ font-size: 11px; line-height: 1.2 }
  .stat > div{ margin: 1px 0 }
  .rail-wrap{ min-height: 450px; margin: 2px 0 8px; gap: 12px; }
  .controls{ gap: 6px; grid-template-columns: 1fr 1fr 1fr; }
  .controls .btn{ padding: 8px 10px; border-radius: 10px; font-size: .9rem; }
  .footer-chip{ transform: scale(.9); right:10px; bottom:10px; padding:6px 10px }
  @media (max-width: 980px){
    h1{ font-size: clamp(18px, 6vw, 26px) }
  }

  .thumb::after{
    content:'';
    position:absolute;
    left:10%; right:10%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 6px rgba(118,160,255,.25);
    border-radius:1px;
    pointer-events:none;
  }

  .thumb-readout{
    position:absolute; right:-84px; top:50%; transform:translateY(-50%);
    min-width:70px; padding:6px 10px; border-radius:12px;
    background:rgba(29,41,68,.92); border:1.2px solid #4b6bb8;
    color:#e7f0ff; font-weight:800; text-align:center; pointer-events:none;
    box-shadow:0 4px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
    z-index:6;
  }
</style>

<!-- Per-deck range controls beside fader: DROPDOWN VERSION -->
<style id="range-controls-in-rail">
  .rail-wrap{ display: grid; grid-template-columns: auto 1fr; align-items: center; column-gap: 12px; }
  .range-ctrls{ display: grid; gap: 8px; align-self: stretch; align-content: center; padding: 4px; }
  .range-ctrls .range-label{ justify-self: start }
  .rail-wrap .rail{ justify-self: center }
  .range-select{
    background: #0f1114;
    color: var(--ink);
    border: 1px solid #272d36;
    border-radius: 10px;
    padding: 8px 10px;
    font-size: .95rem;
    cursor: pointer;
  }
  .range-select:focus{ outline: 2px solid #2563eb; outline-offset: 2px; }

  .thumb::after{
    content:'';
    position:absolute;
    left:10%; right:10%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 6px rgba(118,160,255,.25);
    border-radius:1px;
    pointer-events:none;
  }

  .thumb-readout{
    position:absolute; right:-84px; top:50%; transform:translateY(-50%);
    min-width:70px; padding:6px 10px; border-radius:12px;
    background:rgba(29,41,68,.92); border:1.2px solid #4b6bb8;
    color:#e7f0ff; font-weight:800; text-align:center; pointer-events:none;
    box-shadow:0 4px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
    z-index:6;
  }
</style>

<!-- === Tick Guides Glow Overrides (non-breaking) === -->
<style id="tick-glow-overrides">
.tick{ 
  background:#4b6cff !important;
  opacity:.5;
  transition:opacity .2s ease, box-shadow .25s ease;
}
.tick.long{
  background:#8fb3ff !important;
  opacity:.95;
  box-shadow:0 0 6px #5e85ff66;
}
.tick.zero{
  background:#00ff9d !important;
  box-shadow:0 0 8px #00ff9d, 0 0 14px rgba(0,255,157,.6);
}
.tick .label{
  color:#b7c8ff !important;
  text-shadow:0 0 4px rgba(91,136,255,.6);
}
.rail:hover .tick.long,
.rail:hover .tick.zero{
  opacity:1;
  box-shadow:0 0 10px #7ea5ff, 0 0 20px rgba(91,136,255,.55);
}
.rail:hover .tick.zero{
  box-shadow:0 0 12px #00ffb0, 0 0 22px rgba(0,255,157,.7);
}
</style>


<style id="tap-layout-overrides">
/* Mantener mismas dimensiones del recuadro */
.orig-box{ position: relative; }
.orig-box .bpm-edit{ margin:6px 0 8px; }
.orig-box .orig-caption{
  position:absolute; left:16px; bottom:12px; margin:0; padding:0;
  font-weight:700; font-size:.9rem; color:#dfe7fb; pointer-events:none;
}
.orig-box .orig-top{ display:flex; align-items:center; gap:10px; }
/* Botón TAP pequeño */
.tap-btn{
  background:linear-gradient(180deg,#16331f,#112818);
  border:1.2px solid rgba(0,255,157,.55);
  color:#bfffe6; font-weight:800; letter-spacing:.04em;
  padding:4px 10px; border-radius:999px; cursor:pointer; user-select:none;
  font-size:.78rem; line-height:1;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 2px 8px rgba(0,0,0,.25);
}
.tap-btn:active{ transform:translateY(1px); }
</style>

</head>
<body>
  <h1>Dual Deck Vinyl Tempo Helper</h1>

  <div class="wrap">
    <!-- LEFT -->
    <section class="deck" id="deckL">
      <h2>DECK IZQUIERDA</h2>
      <div class="stat" aria-live="polite">
        <div class="readouts" aria-live="polite">
          <div class="tempo-box" role="group" aria-label="Tempo actual">
            <div class="tempo-title">Tempo actual</div>
            <div class="tempo-value"><span class="tempoNow">120,0 BPM</span></div>
          </div>
          <div class="orig-box" role="group" aria-label="BPM original">
            <div class="orig-top"><button class="tap-btn" data-act="tapTempo" aria-label="Tap tempo L">TAP</button><span class="chip" id="chipQuartzL" hidden>QUARTZ LOCK</span></div>
<div class="bpm-edit">
              <button class="btn" data-act="bpmMinus">−</button>
              <input class="bpm-field" inputmode="decimal" step="1" min="30" max="300" value="120.0" aria-label="BPM original izquierda"/>
              <button class="btn" data-act="bpmPlus">＋</button>
            </div>
          </div>
        </div>
            <div class="orig-caption">BPM original</div>
            <div class="orig-caption">BPM original</div>
        <div>Objetivo (otro deck): <b class="target">120,0 BPM</b></div>
        <div><span class="from-center">0,00%</span> desde el centro</div>
        <div>Offset físico: <span class="offset">0,00%</span></div>
        <div>Notch actual: <span class="notch">0,00%</span></div>
      </div>
      <div class="rail-wrap">
        <div class="range-ctrls">
          <label for="rangeSelectL" class="range-label">Rango del fader</label>
          <select id="rangeSelectL" class="range-select" aria-label="Selecciona rango del fader izquierda">
            <option value="0.08">±8%</option>
            <option value="0.10" selected>±10%</option>
            <option value="0.16">±16%</option>
            <option value="0.20">±20%</option>
          </select>
        </div>
        <div class="rail" data-side="L">
          <div class="edge"></div>
          <div class="ticks"></div>
          <div class="ghost"></div>
          <div class="thumb" tabindex="0" role="slider" aria-valuemin="-10" aria-valuemax="10" aria-valuenow="0" style="top:50%">0,00%</div>
          <div class="thumb-readout">0,00%</div>
          <div class="endmark top">−</div><div class="endmark bot">＋</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" data-act="calibrate">Calibrar cero físico</button>
        <button class="btn" data-act="resetOffset">Restablecer offset</button>
        <button class="btn" id="alignR2L" data-align>Alinear BPM´s con Plato de la Derecha</button>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="deck" id="deckR">
      <h2>DECK DERECHA</h2>
      <div class="stat" aria-live="polite">
        <div class="readouts" aria-live="polite">
          <div class="tempo-box" role="group" aria-label="Tempo actual">
            <div class="tempo-title">Tempo actual</div>
            <div class="tempo-value"><span class="tempoNow">120,0 BPM</span></div>
          </div>
          <div class="orig-box" role="group" aria-label="BPM original">
            <div class="orig-top"><button class="tap-btn" data-act="tapTempo" aria-label="Tap tempo R">TAP</button><span class="chip" id="chipQuartzR" hidden>QUARTZ LOCK</span></div>
<div class="bpm-edit">
              <button class="btn" data-act="bpmMinus">−</button>
              <input class="bpm-field" inputmode="decimal" step="1" min="30" max="300" value="120.0" aria-label="BPM original derecha"/>
              <button class="btn" data-act="bpmPlus">＋</button>
            </div>
          </div>
        </div>
        <div>Objetivo (otro deck): <b class="target">120,0 BPM</b></div>
        <div><span class="from-center">0,00%</span> desde el centro</div>
        <div>Offset físico: <span class="offset">0,00%</span></div>
        <div>Notch actual: <span class="notch">0,00%</span></div>
      </div>
      <div class="rail-wrap">
        <div class="range-ctrls">
          <label for="rangeSelectR" class="range-label">Rango del fader</label>
          <select id="rangeSelectR" class="range-select" aria-label="Selecciona rango del fader derecha">
            <option value="0.08">±8%</option>
            <option value="0.10" selected>±10%</option>
            <option value="0.16">±16%</option>
            <option value="0.20">±20%</option>
          </select>
        </div>
        <div class="rail" data-side="R">
          <div class="edge"></div>
          <div class="ticks"></div>
          <div class="ghost"></div>
          <div class="thumb" tabindex="0" role="slider" aria-valuemin="-10" aria-valuemax="10" aria-valuenow="0" style="top:50%">0,00%</div>
          <div class="thumb-readout">0,00%</div>
          <div class="endmark top">−</div><div class="endmark bot">＋</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" data-act="calibrate">Calibrar cero físico</button>
        <button class="btn" data-act="resetOffset">Restablecer offset</button>
        <button class="btn" id="alignL2R" data-align>Alinear BPM´s con Plato de la Izquierda</button>
      </div>
    </section>
  </div>

  <div class="footer-chip">Hecho por GuilTeach</div>

<script>
// === Utilidades y estado ===
const fmtPct = (v)=> new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
const fmtBpm = (v)=> new Intl.NumberFormat('es-ES',{minimumFractionDigits:1,maximumFractionDigits:1}).format(v);
const clamp = (v,lo,hi)=> Math.min(hi, Math.max(lo,v));

const state = {
  decks: {
    L: { bpm:120.0, pNom:0, offset:0, tempo:120.0, range:0.10 },
    R: { bpm:120.0, pNom:0, offset:0, tempo:120.0, range:0.10 }
  }
};

function effectivePitch(pNom, offset){
  const raw = pNom - offset;
  return (Math.abs(raw) <= 0.001) ? 0 : raw;
}
function snapIfClose(pNom, offset){
  const raw = pNom - offset;
  if (Math.abs(raw) <= 0.0015) return offset;
  return pNom;
}
function pNomFromTempo(targetTempo, bpm, offset){
  const pEff = (targetTempo / bpm) - 1;
  return pEff + offset;
}
function tempoFrom(pNom, bpm, offset){
  const pEff = effectivePitch(pNom, offset);
  return bpm * (1 + pEff);
}
function adjustBpmPreservingTempo(deckKey, newBpm){
  const d = state.decks[deckKey];
  const tempoPrev = tempoFrom(d.pNom, d.bpm, d.offset);
  d.bpm = clamp(newBpm, 30, 300);
  const pEffNew = (tempoPrev / d.bpm) - 1;
  d.pNom = clamp(pEffNew + d.offset, -d.range, d.range);
}

// === Captura de UI ===
const ui = {
  L: buildDeck('deckL','L'),
  R: buildDeck('deckR','R'),
  alignR2L: document.getElementById('alignR2L'),
  alignL2R: document.getElementById('alignL2R'),
  chipQuartzL: document.getElementById('chipQuartzL'),
  chipQuartzR: document.getElementById('chipQuartzR'),
};

function buildDeck(rootId, key){
  const root = document.getElementById(rootId);
  return {
    root, key,
    rail: root.querySelector('.rail'),
    ticks: root.querySelector('.ticks'),
    ghost: root.querySelector('.ghost'),
    thumb: root.querySelector('.thumb'),
    thumbReadout: root.querySelector('.thumb-readout'),
    bpmField: root.querySelector('.bpm-field'),
    bpmMinus: root.querySelector('[data-act="bpmMinus"]'),
    bpmPlus: root.querySelector('[data-act="bpmPlus"]'),
    tempoNow: root.querySelector('.tempoNow'),
    target: root.querySelector('.target'),
    fromCenter: root.querySelector('.from-center'),
    offset: root.querySelector('.offset'),
    notch: root.querySelector('.notch'),
    calibrate: root.querySelector('[data-act="calibrate"]'),
    resetOffset: root.querySelector('[data-act="resetOffset"]'),
    rangeLabel: root.querySelector('.range-label'),
    rangeSelect: root.querySelector('.range-select'),
  };
}

// === Dibujo de ticks y conversión ===
function pctToY(pNom, range){
  return (pNom + range) / (2*range);
}
function yToPct(y, range){
  return (y * (2*range)) - range;
}

function buildTicks(deck){
  const r = state.decks[deck.key].range; // 0.08, 0.10, 0.16, 0.20
  const ticks = deck.ticks;
  ticks.innerHTML = '';

  const near = (a,b)=> Math.abs(a-b) < 1e-6;
  const min = -r*100, max = r*100;

  if (near(r,0.10) || near(r,0.20)){
    // Mantener 21 líneas fijas en ±10 y ±20
    const divisions = 20;
    const step = (max - min) / divisions;
    for(let i=0; i<=divisions; i++){
      const p = min + i*step;
      const y = pctToY(p/100, r);
      const tick = document.createElement('div');
      const isZero = Math.abs(p) < 1e-6;
      const isLong = (i % 2 === 0);
      tick.className = 'tick' + (isLong?' long':'') + (isZero?' zero':'');
      tick.style.top = (y*100)+'%';
      if(isZero || isLong){
        const lab = document.createElement('span');
        lab.className = 'label';
        const stepIsInt = Math.abs(Math.round(step) - step) < 1e-6;
        const v = stepIsInt ? Math.round(p).toString()
                            : (Math.round(p*10)/10).toString().replace('.', ',');
        lab.textContent = (p>0?`+${v}`:`${v}`) + '%';
        tick.appendChild(lab);
      }
      ticks.appendChild(tick);
    }
    return;
  }

  if (near(r,0.08)){
    // ±8: líneas cada 1%, etiqueta cada 2%
    for(let p = Math.ceil(min); p <= Math.floor(max); p += 1){
      const y = pctToY(p/100, r);
      const tick = document.createElement('div');
      const isZero = (p === 0);
      const isLong = (p % 2 === 0);
      tick.className = 'tick' + (isLong?' long':'') + (isZero?' zero':'');
      tick.style.top = (y*100)+'%';
      if(isZero || isLong){
        const lab = document.createElement('span');
        lab.className = 'label';
        lab.textContent = (p>0?`+${p}`:`${p}`) + '%';
        tick.appendChild(lab);
      }
      ticks.appendChild(tick);
    }
    return;
  }

  if (near(r,0.16)){
    // ±16: mismo número de líneas que ±8 → líneas cada 2%, etiqueta cada 4%
    for(let p = Math.ceil(min/2)*2; p <= Math.floor(max/2)*2; p += 2){
      const y = pctToY(p/100, r);
      const tick = document.createElement('div');
      const isZero = (p === 0);
      const isLong = (p % 4 === 0);
      tick.className = 'tick' + (isLong?' long':'') + (isZero?' zero':'');
      tick.style.top = (y*100)+'%';
      if(isZero || isLong){
        const lab = document.createElement('span');
        lab.className = 'label';
        lab.textContent = (p>0?`+${p}`:`${p}`) + '%';
        tick.appendChild(lab);
      }
      ticks.appendChild(tick);
    }
    return;
  }
}

// === Render de cada deck ===
function renderDeck(deck){
  const d = state.decks[deck.key];
  const pEff = effectivePitch(d.pNom, d.offset);
  const tempo = tempoFrom(d.pNom, d.bpm, d.offset);
  d.tempo = tempo;

  const y = pctToY(d.pNom, d.range);
  deck.thumb.style.top = (y*100)+'%';
  deck.thumb.textContent = '';
  if(deck.thumbReadout){ deck.thumbReadout.style.top = (y*100)+'%'; deck.thumbReadout.textContent = `${fmtPct(d.pNom*100)}%`; }
  deck.thumb.setAttribute('aria-valuemin', String(-d.range*100));
  deck.thumb.setAttribute('aria-valuemax', String(d.range*100));
  deck.thumb.setAttribute('aria-valuenow', String((d.pNom*100).toFixed(2)));

  if(document.activeElement !== deck.bpmField){
    deck.bpmField.value = fmtBpm(d.bpm);
  }
  deck.tempoNow.textContent = `${fmtBpm(tempo)} BPM`;
  deck.target.textContent = `${fmtBpm(state.decks[deck.key==='L'?'R':'L'].tempo)} BPM`;
  deck.fromCenter.textContent = `${fmtPct(pEff*100)}%`;
  deck.offset.textContent = `${fmtPct(d.offset*100)}%`;
  deck.notch.textContent = `${fmtPct(d.pNom*100)}%`;

  deck.rangeLabel.textContent = `Rango actual: ±${fmtPct(d.range*100)}%`;
  if (deck.rangeSelect && document.activeElement !== deck.rangeSelect) {
    deck.rangeSelect.value = d.range.toFixed(2);
  }
  buildTicks(deck);

  const chipEl = (deck.key==='L'? ui.chipQuartzL : ui.chipQuartzR);
  const quartzOn = (pEff === 0);
  chipEl.hidden = !quartzOn;
  chipEl.classList.toggle('green', quartzOn);
}

function renderAll(){
  renderDeck(ui.L);
  renderDeck(ui.R);
}

// === Interacciones del fader y campo BPM ===
function addFaderInteractions(deck){
  const rail = deck.rail, thumb = deck.thumb;

  let dragging = false;
  const railRect = ()=> rail.getBoundingClientRect();

  function setFromClientY(clientY, opts={snap:true}){
    const rect = railRect();
    const y = clamp((clientY - rect.top) / rect.height, 0, 1);
    const d = state.decks[deck.key];
    let pNom = yToPct(y, d.range);
    if (opts.snap) pNom = snapIfClose(pNom, state.decks[deck.key].offset);
    state.decks[deck.key].pNom = clamp(pNom, -d.range, d.range);
    renderDeck(deck);
  }

  rail.addEventListener('pointerdown', (e)=>{
    e.preventDefault(); rail.setPointerCapture(e.pointerId);
    dragging = true; setFromClientY(e.clientY, {snap:false});
  });
  rail.addEventListener('pointermove', (e)=>{
    if(!dragging) return; setFromClientY(e.clientY, {snap:false});
  });
  rail.addEventListener('pointerup', (e)=>{
    if(!dragging) return; dragging=false; setFromClientY(e.clientY, {snap:true});
  });

  thumb.addEventListener('keydown', (e)=>{
    if(e.key!=='ArrowUp' && e.key!=='ArrowDown') return;
    e.preventDefault();
    const step = e.shiftKey ? 0.001 : 0.0001;
    const dir = (e.key==='ArrowUp' ? -1 : 1);
    let p = state.decks[deck.key].pNom + dir*step;
    const d = state.decks[deck.key];
    p = clamp(p, -d.range, d.range);
    p = snapIfClose(p, state.decks[deck.key].offset);
    state.decks[deck.key].pNom = p;
    renderDeck(deck);
  });

  // Input BPM interactions (con salida a 1 decimal)
  deck.bpmField.addEventListener('input', (e)=>{
    if (document.activeElement === deck.bpmField && deck.bpmField.value !== '' && deck.bpmField.checkValidity()){
      const v = Number(deck.bpmField.value.replace(',','.'));
      if (e.inputType === 'insertReplacementText' || e.inputType === undefined) {
        adjustBpmPreservingTempo(deck.key, v);
        renderDeck(deck);
      }
    }
  });
  deck.bpmField.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      commitBpmField(deck);
    }
    if (e.key === 'ArrowUp' || e.key === 'ArrowDown'){
      e.preventDefault();
      const delta = (e.key === 'ArrowUp') ? 1 : -1;
      const raw = parseFloat((deck.bpmField.value || state.decks[deck.key].bpm).toString().replace(',','.'));
      const v = clamp(raw + delta, 30, 300);
      deck.bpmField.value = String(v.toFixed(1));
      adjustBpmPreservingTempo(deck.key, v);
      renderDeck(deck);
    }
  });
  deck.bpmField.addEventListener('blur', ()=> commitBpmField(deck));

  function commitBpmField(deck){
    const val = deck.bpmField.value.trim();
    if (val === '') { renderDeck(deck); return; }
    const raw = Number(val.replace(',','.'));
    if (!Number.isFinite(raw)) { renderDeck(deck); return; }
    adjustBpmPreservingTempo(deck.key, raw);
    renderAll();
  }

  deck.calibrate.addEventListener('click', ()=>{
    const d = state.decks[deck.key];
    d.offset = d.pNom;
    renderAll();
  });
  deck.resetOffset.addEventListener('click', ()=>{
    const d = state.decks[deck.key];
    d.offset = 0;
    d.pNom = snapIfClose(d.pNom, d.offset);
    renderAll();
  });

  // Range select interactions
  if (deck.rangeSelect){
    deck.rangeSelect.addEventListener('change', ()=>{
      const newRange = parseFloat(deck.rangeSelect.value);
      setRangeFor(deck.key, newRange);
    });
  }
}

// NEW: per-deck range setter (dropdown)
function setRangeFor(key, newRange){
  const d = state.decks[key];
  d.range = clamp(newRange, 0.01, 0.50);
  d.pNom = clamp(d.pNom, -d.range, d.range);
  renderDeck(ui[key]);
}

// === Alinear tempos ===
function alignTempos(sourceKey, targetKey){
  const src = state.decks[sourceKey], tgt = state.decks[targetKey];
  const pNeeded = pNomFromTempo(tgt.tempo, src.bpm, src.offset);
  src.pNom = clamp(pNeeded, -src.range, src.range);
  src.pNom = snapIfClose(src.pNom, src.offset);
  renderAll();
}

// === Smart-press: click corto = ±0,1; mantener = aceleración 3 fases ===
function addSmartPress(button, deckKey, direction){
  if(!button) return;
  let startTs=0, holdTimer=null, armed=false;
  const clickWindow=180;  // ms: si sueltas antes de esto → un solo paso pequeño
  const rateSmall=120, rateMed=80, rateLarge=50;
  const T1=2000, T2=4000;

  function stepSmall(){ adjustBpmPreservingTempo(deckKey, state.decks[deckKey].bpm + direction*0.1); renderDeck(ui[deckKey]); }
  function stepMedium(){ adjustBpmPreservingTempo(deckKey, state.decks[deckKey].bpm + direction*0.25); renderDeck(ui[deckKey]); }
  function stepLarge(){ adjustBpmPreservingTempo(deckKey, state.decks[deckKey].bpm + direction*0.5); renderDeck(ui[deckKey]); }

  function start(){
    startTs=Date.now();
    armed=true;
    // Empieza repetición tras un pequeño retardo, sin dar paso inmediato
    holdTimer=setTimeout(function repeater(){
      const elapsed=Date.now()-startTs;
      if(elapsed>=T2){ stepLarge(); holdTimer=setTimeout(repeater, rateLarge); }
      else if(elapsed>=T1){ stepMedium(); holdTimer=setTimeout(repeater, rateMed); }
      else { stepSmall(); holdTimer=setTimeout(repeater, rateSmall); }
    }, 220);
  }
  function end(){
    const elapsed=Date.now()-startTs;
    clearTimeout(holdTimer);
    if(armed && elapsed<clickWindow){
      stepSmall(); // clic corto
    }
    armed=false;
  }

  // Mouse
  button.addEventListener('mousedown', start);
  button.addEventListener('mouseup', end);
  button.addEventListener('mouseleave', end);
  // Touch
  button.addEventListener('touchstart', (e)=>{ e.preventDefault(); start(); }, {passive:false});
  ['touchend','touchcancel'].forEach(ev=> button.addEventListener(ev, end));
}


// === Tap Tempo por deck (solo cambia BPM original del tema) ===
function addTapTempo(deck){
  const btn = deck.root.querySelector('[data-act="tapTempo"]');
  if(!btn) return;
  let taps = [];
  const RESET_MS = 1800;
  const MAX_TAPS = 6;
  function registerTap(){
    const now = performance.now();
    if(taps.length && (now - taps[taps.length-1] > RESET_MS)) taps = [];
    taps.push(now);
    if(taps.length < 2) return;
    const intervals = [];
    for(let i=1;i<taps.length;i++) intervals.push(taps[i]-taps[i-1]);
    const recent = intervals.slice(-MAX_TAPS).sort((a,b)=>a-b);
    const cut = Math.max(0, Math.floor(recent.length*0.1));
    const trimmed = recent.slice(cut, recent.length-cut);
    const avgMs = trimmed.reduce((s,v)=>s+v,0)/trimmed.length;
    if(!isFinite(avgMs) || avgMs<=0) return;
    const bpmRounded = Math.round((60000/avgMs)*10)/10;
    const d = state.decks[deck.key];
    d.bpm = clamp(bpmRounded, 30, 300); // solo cambiamos BPM original
    renderDeck(deck);
    btn.animate([{transform:'scale(1)'},{transform:'scale(0.96)'},{transform:'scale(1)'}],{duration:140});
  }
  btn.addEventListener('click', registerTap);
  btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); registerTap(); }, {passive:false});
}

// === Inicialización ===
document.addEventListener('DOMContentLoaded', ()=>{
  // Interacciones de fader y campos
  addFaderInteractions(ui.L);
  addFaderInteractions(ui.R);
  // Tap tempo por deck
  addTapTempo(ui.L);
  addTapTempo(ui.R);

  // Botones de alineación
  ui.alignR2L.addEventListener('click', ()=> alignTempos('L','R'));
  ui.alignL2R.addEventListener('click', ()=> alignTempos('R','L'));

  // Smart-press en botones BPM
  addSmartPress(ui.L.bpmMinus, 'L', -1);
  addSmartPress(ui.L.bpmPlus,  'L',  1);
  addSmartPress(ui.R.bpmMinus, 'R', -1);
  addSmartPress(ui.R.bpmPlus,  'R',  1);

  // Render inicial
  renderAll();
});
</script>
</body>
</html>
